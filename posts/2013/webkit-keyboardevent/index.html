<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    
    <meta name="description" content="石头的博客.">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:domain" content="http://oopschen.github.io">
    
    <meta name="twitter:image" content="http://oopschen.github.io/tn.png">
    <meta name="twitter:title" property="og:title" itemprop="title name" content="Oopschen的日志">
    <meta name="twitter:description" property="og:description" itemprop="description" content="石头的博客.">
    <meta name="og:type" content="website">
    <meta name="og:url" content="http://oopschen.github.io">
    <meta name="og:image" itemprop="image primaryImageOfPage" content="http://oopschen.github.io/tn.png">
    
    <title>webkit下的KeyboardEvent模拟</title>
    <link rel="shortcut icon" href="http://oopschen.github.io/sam.ico" id="favicon">
    <link rel="stylesheet" href="http://oopschen.github.io/css/style.css">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">
    
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-49453400-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-49453400-1');
    </script>
    

</head>

</html>
<body><div class="wrap"><div class="section" id="title">webkit下的KeyboardEvent模拟</div><div class="section" id="content">Mon Jun 17, 2013 &#183; 226 words

<div><span id="tag"><a href="http://oopschen.github.io/tags/webkit">webkit</a></span><span id="tag"><a href="http://oopschen.github.io/tags/js%E6%A8%A1%E6%8B%9Fkeyboardevent">js模拟KeyboardEvent</a></span></div><hr/>

<p>在javascript中模拟dom的事件是一件非常有趣的事情,他不仅可以将人工机器化,也让页面变得更加丰富。DOM时间参考资料可参见<a href="http://www.w3.org/TR/DOM-Level-2-Events/" title="DOM2 EVENT SPEC">DOM2</a>和<a href="http://www.w3.org/TR/DOM-Level-3-Events/" title="DOM3 EVENT SPEC">DOM3</a>。</p>

<h4 id="常用方式">常用方式</h4>

<p>我们在javascript中模拟dom事件一般用两种方法：</p>

<h5 id="调用事件函数">调用事件函数</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">    <span style="color:#a6e22e">element</span>.<span style="color:#a6e22e">click</span>();
</code></pre></div>
<h5 id="创建事件对象">创建事件对象</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">evt</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createEvent</span>(<span style="color:#e6db74">&#34;MouseEvent&#34;</span>);
    <span style="color:#a6e22e">evt</span>.<span style="color:#a6e22e">initMouseEvent</span>(
      <span style="color:#e6db74">&#34;click&#34;</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">true</span>, document.<span style="color:#a6e22e">defaultView</span>,
      <span style="color:#ae81ff">1</span>, window.<span style="color:#a6e22e">screenX</span>, window.<span style="color:#a6e22e">screenY</span>,
      <span style="color:#a6e22e">clientX</span>, <span style="color:#a6e22e">clientY</span>,
      <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">null</span>
    );
    <span style="color:#a6e22e">element</span>.<span style="color:#a6e22e">dispatchEvent</span>(<span style="color:#a6e22e">evt</span>);
</code></pre></div>
<h5 id="区别">区别</h5>

<p>这两种方式其实没有区别,都会进行完整的时间传递从capture phase到target phase,最后bubble phase。唯一的区别是后者可以自定义一些事件相关的参数,比如点击的位置等。</p>

<h4 id="webkit-中keyboardevent">webkit 中KeyboardEvent</h4>

<p>在webkit中无法通过KeyboardEvent来完全模拟按键,原因是webkit中的实现和DOM3的标准不一致。我们来看下DOM3中对KeyboardEvent的initKeyboardEvent函数的定义：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">    <span style="color:#75715e">// Event Constructor Syntax:
</span><span style="color:#75715e"></span>    [<span style="color:#a6e22e">Constructor</span>(<span style="color:#a6e22e">DOMString</span> <span style="color:#a6e22e">typeArg</span>, <span style="color:#a6e22e">optional</span> <span style="color:#a6e22e">KeyboardEventInit</span> <span style="color:#a6e22e">keyboardEventInitDict</span>)]
    <span style="color:#a6e22e">partial</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">KeyboardEvent</span>
    {
      <span style="color:#75715e">// Originally introduced (and deprecated) in DOM Level 3:
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initKeyboardEvent</span>(<span style="color:#a6e22e">DOMString</span> <span style="color:#a6e22e">typeArg</span>,
                             <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">canBubbleArg</span>,
                             <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">cancelableArg</span>,
                             <span style="color:#a6e22e">AbstractView</span><span style="color:#f92672">?</span> <span style="color:#a6e22e">viewArg</span>,
                             <span style="color:#a6e22e">DOMString</span> <span style="color:#a6e22e">charArg</span>,
                             <span style="color:#a6e22e">DOMString</span> <span style="color:#a6e22e">keyArg</span>,
                             <span style="color:#a6e22e">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">locationArg</span>,
                             <span style="color:#a6e22e">DOMString</span> <span style="color:#a6e22e">modifiersListArg</span>,
                             <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">repeat</span>,
                             <span style="color:#a6e22e">DOMString</span> <span style="color:#a6e22e">localeArg</span>);
    };
</code></pre></div>
<p>我们来主要看几个参数：</p>

<ol>
<li>charArg表示按键的值和keyArg等同,如果值是不可见字符则charArg为空字符</li>
<li>modifiersListArg表示是否有按键Control等修饰符
<br /></li>
</ol>

<p>然而在webkit中*core/dom/KeyboardEvent.idl*中确是这样的代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">    <span style="color:#75715e">// FIXME: this does not match the version in the DOM spec.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initKeyboardEvent</span>([<span style="color:#a6e22e">Default</span><span style="color:#f92672">=</span><span style="color:#a6e22e">Undefined</span>] <span style="color:#a6e22e">optional</span> <span style="color:#a6e22e">DOMString</span> <span style="color:#a6e22e">type</span>, 
                           [<span style="color:#a6e22e">Default</span><span style="color:#f92672">=</span><span style="color:#a6e22e">Undefined</span>] <span style="color:#a6e22e">optional</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">canBubble</span>, 
                           [<span style="color:#a6e22e">Default</span><span style="color:#f92672">=</span><span style="color:#a6e22e">Undefined</span>] <span style="color:#a6e22e">optional</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">cancelable</span>, 
                           [<span style="color:#a6e22e">Default</span><span style="color:#f92672">=</span><span style="color:#a6e22e">Undefined</span>] <span style="color:#a6e22e">optional</span> <span style="color:#a6e22e">DOMWindow</span> <span style="color:#a6e22e">view</span>, 
                           [<span style="color:#a6e22e">Default</span><span style="color:#f92672">=</span><span style="color:#a6e22e">Undefined</span>] <span style="color:#a6e22e">optional</span> <span style="color:#a6e22e">DOMString</span> <span style="color:#a6e22e">keyIdentifier</span>,
                           [<span style="color:#a6e22e">Default</span><span style="color:#f92672">=</span><span style="color:#a6e22e">Undefined</span>] <span style="color:#a6e22e">optional</span> <span style="color:#a6e22e">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">keyLocation</span>,
                           [<span style="color:#a6e22e">Default</span><span style="color:#f92672">=</span><span style="color:#a6e22e">Undefined</span>] <span style="color:#a6e22e">optional</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">ctrlKey</span>,
                           [<span style="color:#a6e22e">Default</span><span style="color:#f92672">=</span><span style="color:#a6e22e">Undefined</span>] <span style="color:#a6e22e">optional</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">altKey</span>,
                           [<span style="color:#a6e22e">Default</span><span style="color:#f92672">=</span><span style="color:#a6e22e">Undefined</span>] <span style="color:#a6e22e">optional</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">shiftKey</span>,
                           [<span style="color:#a6e22e">Default</span><span style="color:#f92672">=</span><span style="color:#a6e22e">Undefined</span>] <span style="color:#a6e22e">optional</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">metaKey</span>,
                           [<span style="color:#a6e22e">Default</span><span style="color:#f92672">=</span><span style="color:#a6e22e">Undefined</span>] <span style="color:#a6e22e">optional</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">altGraphKey</span>);
</code></pre></div>
<p>和上面完全不一致,而从实现的类的177到200行来看我们无法通过创建KeyboardEvent来创建一个按键,因为无法设置keyCode值。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">KeyboardEvent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">keyCode</span>() <span style="color:#66d9ef">const</span>
    {
        <span style="color:#75715e">// IE: virtual key code for keyup/keydown, character code for keypress
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Firefox: virtual key code for keyup/keydown, zero for keypress
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// We match IE.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">m_keyEvent</span>)
            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">type</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">eventNames</span>().<span style="color:#a6e22e">keydownEvent</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">type</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">eventNames</span>().<span style="color:#a6e22e">keyupEvent</span>)
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">windowsVirtualKeyCodeWithoutLocation</span>(<span style="color:#a6e22e">m_keyEvent</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">windowsVirtualKeyCode</span>());

        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">charCode</span>();
    }
    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">KeyboardEvent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">charCode</span>() <span style="color:#66d9ef">const</span>
    {
        <span style="color:#75715e">// IE: not supported
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Firefox: 0 for keydown/keyup events, character code for keypress
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// We match Firefox
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">m_keyEvent</span> <span style="color:#f92672">||</span> (<span style="color:#a6e22e">type</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">eventNames</span>().<span style="color:#a6e22e">keypressEvent</span>))
            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
        String <span style="color:#a6e22e">text</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">m_keyEvent</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">text</span>();
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">text</span>.<span style="color:#a6e22e">characterStartingAt</span>(<span style="color:#ae81ff">0</span>));
    }
</code></pre></div>
<p>m_keyEvent是一个PlatformKeyboardEvent的实例,而这个实例无法通过js创建。</p>

<h4 id="总结">总结</h4>

<p>在这个实现未被修改之前,我们仍无法通过javascript在webkit内核下创建一个真实的按键效果。</p>
</div><div class="section bottom-menu"><hr/><p>
<a href="/posts">back</a>
 &#183;



<a href="/posts">博客日志</a>


&#183; <a href="/about">我是谁?</a>

&#183; <a href="http://oopschen.github.io">home</a></p></div><div class="section footer">石头, OOPS!!!</div></div></body>